# 0004: WebSocket プロトコルで制御メッセージと入出力データを分離

## Status

Proposed

## Context

kastty ではブラウザとサーバ間で以下のデータをやり取りする：

- ターミナル入出力（生のバイト列 / 文字列）
- 制御コマンド（resize、ping/pong 等）
- サーバイベント（hello、exit、error 等）

これらを単一の WebSocket 接続で効率的に扱うプロトコル設計が必要。また、将来 Go / Rust へ移植する際に Bun 固有の概念がプロトコルに漏れないようにする。

## Decision

入出力データと制御メッセージを以下のように分離する：

**入出力データ**: WebSocket バイナリフレームとしてそのまま送受信する。追加のエンベロープは付与しない。

**制御メッセージ**: WebSocket テキストフレームの JSON として送受信する。`t` フィールドでメッセージタイプを識別する。

```
クライアント → サーバ:
  {"t":"resize","cols":120,"rows":40}
  {"t":"readonly","enabled":true}
  {"t":"ping","ts":...}

サーバ → クライアント:
  {"t":"hello","readonly":false,...}
  {"t":"exit","code":0}
  {"t":"error",...}
  {"t":"pong",...}
```

受信側は WebSocket のフレームタイプ（バイナリ / テキスト）で入出力データと制御メッセージを判別する。バイナリフレームは入出力データ、テキストフレームは JSON 制御メッセージとして扱う。

## Consequences

### Positive

- 入出力データにオーバーヘッドがない（エンベロープ不要）
- 制御メッセージは人間が読みやすい JSON
- ランタイム非依存のプロトコル定義となり、移植しやすい
- シンプルで実装が容易

### Negative

- 実装側がフレームタイプの使い分け規約（バイナリ = 入出力、テキスト = 制御 JSON）に準拠する必要がある
- 将来的にバイナリ形式の制御メッセージが必要になった場合、フレームタイプだけでは判別できなくなるため追加の仕組みが必要

### Neutral

- JSON 固定か将来バイナリ化が必要かは Open Question として残す
