# 0005: kastty をブロッキングコマンドとし、PTY ライフサイクルをプロセスに紐付け

## Status

Proposed

## Context

kastty の PTY セッションをいつ終了するかについて、2 つのアプローチが考えられた：

1. ブラウザ（WS クライアント）が切断したら PTY を終了する
2. `kastty` プロセスのライフサイクルに PTY を紐付ける

前者はシンプルだが、ブラウザを誤って閉じた場合に作業が失われる。後者であれば `kastty` コマンドをフォアグラウンドでブロックさせることで、セッション管理の複雑さを回避しつつ PTY を維持できる。

## Decision

`kastty` をフォアグラウンドでブロックするコマンドとして動作させる（`python -m http.server` と同じモデル）。

- PTY ライフサイクル = `kastty` プロセスライフサイクル
- ブラウザは「接続してくるビューア」として扱い、切断/再接続は自由
- 終了条件: PTY 内のプロセスが exit するか、ユーザーが `Ctrl+C` で `kastty` を停止する
- 再接続時は出力リプレイバッファ（サーバ側リングバッファ、上限 1 MB）を一括送信し、クライアント側ターミナルエミュレータが画面を復元する。サーバ側での VT 状態解析は行わない

## Consequences

### Positive

- セッション管理が不要（orphan PTY のクリーンアップ、タイムアウト等が不要）
- 誤ってブラウザを閉じても PTY が生きている
- メンタルモデルが明快（kastty を起動している間 = ターミナル共有中）
- リロードでの再接続が自然に動作する

### Negative

- 再接続時の画面復元のために、出力リプレイバッファ（リングバッファ）の管理が必要。バッファ上限を超えた古い出力は失われるが、直近の画面復元には十分である
- `kastty` プロセスが常にフォアグラウンドを占有する（デーモン化は将来の拡張）

### Neutral

- 複数クライアント共有ポリシー（[0013](0013-multi-client-shared-session.md)）と組み合わせ、ブラウザ接続の増減にかかわらず PTY を維持する
