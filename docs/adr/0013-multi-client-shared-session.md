# 0013: 同一トークンで複数クライアント接続を許可し単一PTYセッションを共有

## Status

Accepted

## Context

同一 URL（`?t=<token>`）を複数タブで開いた際に、同じ kastty セッションを同時に参照したい要件がある。
従来の接続ポリシー（[0003](0003-single-client-connection.md)）では単一クライアントのみ許可していたため、新規タブ接続が拒否されていた。

一方で主用途は「1 人の操作者による複数タブ表示」であり、同時編集の競合解決（ロック、OT、CRDT）までは v1 要件に含まれない。

## Decision

接続ポリシーを次のように変更する。

- 同一トークンに対する WebSocket 接続を複数同時に許可する
- サーバは単一 PTY セッションを維持し、出力を全接続クライアントへブロードキャストする
- PTY exit イベントは全接続クライアントへ通知する
- `readonly` はサーバを単一の真実源とし、切替時に全接続クライアントへ状態通知する
- 同時操作者の入力競合制御は導入しない（複数操作者は非推奨）

## Consequences

### Positive

- 同じ URL を複数タブで開いて同一セッションを同時表示できる
- タブを閉じても他タブで作業継続しやすい
- read-only 状態をタブ間で同期でき、UI の不整合が減る

### Negative

- 複数操作者が同時入力すると入力が競合・混線しうる
- 接続数に比例してサーバ送信負荷が増える

### Neutral

- 1 PTY を `kastty` プロセスに紐づけるモデル（[0005](0005-blocking-command-pty-lifecycle.md)）は維持される
