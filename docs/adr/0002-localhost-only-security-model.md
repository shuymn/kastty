# 0002: localhost 限定 + Host/Origin/Token 検証によるセキュリティモデル

## Status

Proposed

## Context

kastty はローカル専用ツールだが、localhost であっても以下の脅威が存在する：

- 悪意ある Web サイトからの DNS rebinding / localhost abuse
- ユーザーの誤操作による URL（トークン）共有
- bind 設定ミスによる意図しない LAN 公開

ターミナルへの直接アクセスを提供するため、最低限の防御を v1 から組み込む必要がある。

## Decision

以下のセキュリティモデルを v1 必須とする：

1. **ネットワーク**: デフォルト bind を `127.0.0.1` のみに限定。`0.0.0.0` は v1 非対応または明示 opt-in
2. **Host ヘッダ検証**: `127.0.0.1:<port>`, `localhost:<port>` のみ許可（v1 は IPv4 のみ bind するため `[::1]` は対象外）
3. **Origin ヘッダ検証**: ローカルオリジンのみ許可（WS 含む）
4. **起動時ランダムトークン**: 高エントロピートークンを生成し、HTTP / WS の双方で検証

## Consequences

### Positive

- DNS rebinding 攻撃に対する防御
- 意図しない外部アクセスの防止
- トークンによりプロセス単位でアクセス制御が可能

### Negative

- URL にトークンが含まれるため、誤共有時のリスクが残る（ただしプロセス終了で失効）
- localhost 用途でありながら検証レイヤーが増える分、実装コストが上がる

### Neutral

- v1 では CSRF トークン、多要素認証、アクセス監査ログは非対応とする
- ログへのトークン出力はマスク表示とする
