name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest
    timeout-minutes: 30
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2.1.2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - id: determine_release_tag
        name: Ensure draft release exists
        env:
          GH_PAGER: cat
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          if [[ ${GITHUB_REF} != refs/tags/* ]]; then
            echo "This workflow must run from a tag push."
            exit 1
          fi

          tag="${GITHUB_REF#refs/tags/}"

          for _ in {1..12}; do
            is_draft=$(gh release view "$tag" --json isDraft -q '.isDraft' 2>/dev/null || true)
            if [[ ${is_draft} == "true" ]]; then
              echo "tag=$tag" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            sleep 5
          done

          echo "Release $tag is not a draft or does not exist."
          exit 1

      - name: Build release assets
        env:
          RELEASE_TAG: ${{ steps.determine_release_tag.outputs.tag }}
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p dist
          short_sha="$(git rev-parse --short=7 "$GITHUB_SHA")"
          host_os="$(uname -s)"
          host_arch="$(uname -m)"

          case "${host_os}:${host_arch}" in
            Darwin:arm64)
              verify_target="bun-darwin-arm64"
              ;;
            Darwin:x86_64)
              verify_target="bun-darwin-x64"
              ;;
            Linux:arm64|Linux:aarch64)
              verify_target="bun-linux-arm64"
              ;;
            Linux:x86_64)
              verify_target="bun-linux-x64"
              ;;
            *)
              echo "Unsupported runner for version verification: ${host_os}/${host_arch}"
              exit 1
              ;;
          esac

          build_target() {
            local target="$1"
            local archive_name="$2"
            local outfile="dist/kastty"

            bun build \
              --compile \
              --target="$target" \
              index.ts \
              --outfile "$outfile" \
              --define KASTTY_VERSION='\"'"$RELEASE_TAG"'\"' \
              --define KASTTY_SHORT_SHA='\"'"$short_sha"'\"'

            chmod +x "$outfile" || true

            # bun build --compile leaves an invalid linker signature on macOS.
            # Re-sign with ad-hoc identity so Gatekeeper won't reject the binary.
            if [[ "$target" == bun-darwin-* ]]; then
              codesign -s - --force "$outfile"
            fi

            if [[ "$target" == "$verify_target" ]]; then
              expected="${RELEASE_TAG}+${short_sha}"
              actual="$("$outfile" --version)"
              if [[ "$actual" != "$expected" ]]; then
                echo "version mismatch: expected=$expected actual=$actual"
                exit 1
              fi
            fi

            tar -C dist -czf "dist/$archive_name" kastty
            rm -f "$outfile"
          }

          build_target "bun-darwin-arm64" "kastty-darwin-arm64.tar.gz"
          build_target "bun-darwin-x64" "kastty-darwin-x64.tar.gz"
          build_target "bun-linux-arm64" "kastty-linux-arm64.tar.gz"
          build_target "bun-linux-x64" "kastty-linux-x64.tar.gz"

          (
            cd dist
            shasum -a 256 \
              kastty-darwin-arm64.tar.gz \
              kastty-darwin-x64.tar.gz \
              kastty-linux-arm64.tar.gz \
              kastty-linux-x64.tar.gz > checksums.txt
          )

      - name: Upload assets to draft release
        env:
          RELEASE_TAG: ${{ steps.determine_release_tag.outputs.tag }}
          GH_PAGER: cat
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          gh release upload "$RELEASE_TAG" dist/*.tar.gz dist/checksums.txt --clobber

      - name: Publish draft release
        env:
          RELEASE_TAG: ${{ steps.determine_release_tag.outputs.tag }}
          GH_PAGER: cat
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          is_draft=$(gh release view "$RELEASE_TAG" --json isDraft -q '.isDraft' || echo "false")
          if [[ ${is_draft} != "true" ]]; then
            echo "No draft release found for $RELEASE_TAG"
            exit 1
          fi

          gh release edit "$RELEASE_TAG" --draft=false
