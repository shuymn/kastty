name: Refresh M PLUS Font Assets

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
    branches:
      - main
    paths:
      - package.json
      - bun.lock
      - scripts/generate-m-plus-font-files.ts

permissions:
  contents: write

concurrency:
  group: refresh-m-plus-font-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  refresh-m-plus-font-assets:
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'renovate/')
    timeout-minutes: 20
    permissions:
      contents: write

    steps:
      - name: Create app token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          permission-contents: write

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: false
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Check if @fontsource-variable/m-plus-1-code changed
        id: check-target
        run: |
          set -euo pipefail

          git fetch origin "${{ github.base_ref }}" --depth=1
          if git diff --unified=0 "origin/${{ github.base_ref }}"...HEAD -- package.json bun.lock \
            | grep -Eq '^[+-].*@fontsource-variable/m-plus-1-code'; then
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Bun
        if: steps.check-target.outputs.run == 'true'
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2.1.2
        with:
          bun-version-file: ".bun-version"

      - name: Install dependencies
        if: steps.check-target.outputs.run == 'true'
        run: bun install --frozen-lockfile

      - name: Generate M PLUS font file map
        if: steps.check-target.outputs.run == 'true'
        run: bun run gen:m-plus-font-files

      - name: Commit and push generated map
        if: steps.check-target.outputs.run == 'true'
        env:
          PUSH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set -euo pipefail

          if [[ -z "$(git status --porcelain -- server/m-plus-font-files.ts)" ]]; then
            echo "No M PLUS font map changes detected"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add server/m-plus-font-files.ts
          git commit -m "chore: refresh M PLUS font asset map"

          for attempt in 1 2 3; do
            if git push "https://x-access-token:${PUSH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" HEAD:"${GITHUB_HEAD_REF:?}"; then
              exit 0
            fi

            if [[ "${attempt}" -eq 3 ]]; then
              echo "Push failed after ${attempt} attempts"
              exit 1
            fi

            echo "Push rejected; rebasing on origin/${GITHUB_HEAD_REF:?} and retrying..."
            git fetch origin "${GITHUB_HEAD_REF:?}"
            git rebase "origin/${GITHUB_HEAD_REF:?}"
          done
